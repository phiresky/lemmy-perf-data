<div><table>
<thead><tr><th>Benchmark</th><th>Experiment</th><th>Activity Count</th><th>Total Duration</th><th>Database Exec Time</th><th>Database Query Count</th></tr></thead>
<tbody><tr><td>Import-Reddit-Dump-v1</td><td>pg-asynchronous-commit</td><td>99956</td><td>95.7 s</td><td>124 min 54 s</td><td>3855894</td>
</tr><tr><td>Import-Reddit-Dump-v1</td><td>pg-synchronous-commit</td><td>99895</td><td>7 min 5.15 s</td><td>1180 min 38.8 s</td><td>3838216</td>
</tr></tbody></table><details><summary><h2>Show details</h2></summary><h3>Experiment explanation</h3><p>The experiment <code>Import-Reddit-Dump-v1</code> experiment reads a real dump of reddit content from December 2022, limited to 100k events, and uploads it to a lemmy server as if reddit was another federated instance. The votes use the real counts but simulated users and times (uniformly randomly between 0 and 2h after the post/comment). The benchmarking code is currently in a shitty state in<!-- --> <a href="https://github.com/phiresky/lemmy/tree/reddit-importer">this branch.</a></p><h3>Column Explanations</h3><table><tr><td>Activity Count</td><td>After Running the import, this is the number of rows in the activity table. It should be almost equal to the number of events uploaded</td></tr><tr><td>Total Duration</td><td>The total wall time it took for the upload to complete (including clearing the federation queue)</td></tr><tr><td>Database Exec Time</td><td>The total time the database spent executing queries. Higher than the wall time since the database does parallel queries. (select sum(total_exec_time) from pg_stat_statements) (excluding<!-- --> <a href="https://github.com/weiznich/diesel_async/discussions/89">SELECT 1</a>)</td></tr><tr><td>Database Query Count</td><td>Total number of database queries executed (select sum(calls) from pg_stat_statements) (excluding<!-- --> <a href="https://github.com/weiznich/diesel_async/discussions/89">SELECT 1</a>)</td></tr></table><h3>Details</h3><table>
<thead><tr><th>Experiment</th><th>Link</th><th>Activityqueue-Stats</th><th>Unique db statements</th><th>Post Count</th><th>Comment Count</th><th>Post Vote Count</th><th>Comment Vote Count</th></tr></thead>
<tbody><tr><td>pg-asynchronous-commit</td><td><a href="https://github.com/phiresky/lemmy-perf-data/tree/main/runs/2023-07-03T17%3A28%3A49%2B00%3A00-pg-asynchronous-commit">2023-07-03T17:28:49+00:00-pg-asynchronous-commit</a></td><td>Some(Activity queue stats: pending: 0, running: 0, retries: 0, dead: 0, complete: 100000)</td><td>1386</td><td>4143</td><td>13025</td><td>42029</td><td>17379</td>
</tr><tr><td>pg-synchronous-commit</td><td><a href="https://github.com/phiresky/lemmy-perf-data/tree/main/runs/2023-07-03T17%3A31%3A43%2B00%3A00-pg-synchronous-commit">2023-07-03T17:31:43+00:00-pg-synchronous-commit</a></td><td>Some(Activity queue stats: pending: 0, running: 0, retries: 0, dead: 0, complete: 100000)</td><td>1385</td><td>4143</td><td>12964</td><td>42029</td><td>17318</td>
</tr></tbody></table></details><details><summary><h2>Top Queries by call count</h2></summary><div><div><h4>Run: <!-- -->pg-asynchronous-commit</h4><table>
<thead><tr><th>Top</th><th>Calls</th><th>Rows</th><th>Toplevel</th><th>Avg. Time</th><th>Total Time</th><th>Query</th></tr></thead>
<tbody><tr><td>1.</td><td><b>2091223</b></td><td>2091223</td><td>Yes</td><td>0.00232 ms</td><td>4.85 s</td><td>SELECT $1</td>
</tr><tr><td>2.</td><td><b>550952</b></td><td>550952</td><td>No</td><td>0.0831 ms</td><td>45.8 s</td><td>SELECT $2 FROM ONLY "public"."language" x WHERE "id" OPERATOR(pg_catalog.=) $1 FOR KEY SHARE OF x</td>
</tr><tr><td>3.</td><td><b>540643</b></td><td>540643</td><td>No</td><td>0.0188 ms</td><td>10.2 s</td><td>SELECT $2 FROM ONLY "public"."community" x WHERE "id" OPERATOR(pg_catalog.=) $1 FOR KEY SHARE OF x</td>
</tr><tr><td>4.</td><td><b>338987</b></td><td>286959</td><td>Yes</td><td>0.0353 ms</td><td>12 s</td><td>SELECT "post"."id", "post"."name", "post"."url", "post"."body", "post"."creator_id", "post"."community_id", "post"."removed", "post"."locked", "post"."published", "post"."updated", "post"."deleted", "post"."nsfw", "post"."embed_title", "post"."embed_description", "post"."thumbnail_url", "post"."ap_id", "post"."local", "post"."embed_video_url", "post"."language_id", "post"."featured_community", "post"."featured_local" FROM "post" WHERE ("post"."ap_id" = $1) LIMIT $2</td>
</tr><tr><td>5.</td><td><b>330108</b></td><td>320328</td><td>Yes</td><td>0.0345 ms</td><td>11.4 s</td><td>SELECT "person"."id", "person"."name", "person"."display_name", "person"."avatar", "person"."banned", "person"."published", "person"."updated", "person"."actor_id", "person"."bio", "person"."local", "person"."private_key", "person"."public_key", "person"."last_refreshed_at", "person"."banner", "person"."deleted", "person"."inbox_url", "person"."shared_inbox_url", "person"."matrix_user_id", "person"."admin", "person"."bot_account", "person"."ban_expires", "person"."instance_id" FROM "person" WHERE (("person"."deleted" = $1) AND ("person"."actor_id" = $2)) LIMIT $3</td>
</tr><tr><td>6.</td><td><b>258152</b></td><td>258151</td><td>Yes</td><td>0.0206 ms</td><td>5.31 s</td><td>SELECT "local_site"."id", "local_site"."site_id", "local_site"."site_setup", "local_site"."enable_downvotes", "local_site"."enable_nsfw", "local_site"."community_creation_admin_only", "local_site"."require_email_verification", "local_site"."application_question", "local_site"."private_instance", "local_site"."default_theme", "local_site"."default_post_listing_type", "local_site"."legal_information", "local_site"."hide_modlog_mod_names", "local_site"."application_email_admins", "local_site"."slur_filter_regex", "local_site"."actor_name_max_length", "local_site"."federation_enabled", "local_site"."captcha_enabled", "local_site"."captcha_difficulty", "local_site"."published", "local_site"."updated", "local_site"."registration_mode", "local_site"."reports_email_admins" FROM "local_site" LIMIT $1</td>
</tr><tr><td>7.</td><td><b>204645</b></td><td>204645</td><td>Yes</td><td>0.0324 ms</td><td>6.63 s</td><td>SELECT "community"."id", "community"."name", "community"."title", "community"."description", "community"."removed", "community"."published", "community"."updated", "community"."deleted", "community"."nsfw", "community"."actor_id", "community"."local", "community"."private_key", "community"."public_key", "community"."last_refreshed_at", "community"."icon", "community"."banner", "community"."followers_url", "community"."inbox_url", "community"."shared_inbox_url", "community"."hidden", "community"."posting_restricted_to_mods", "community"."instance_id", "community"."moderators_url", "community"."featured_url" FROM "community" WHERE ("community"."id" = $1) LIMIT $2</td>
</tr><tr><td>8.</td><td><b>158195</b></td><td>0</td><td>Yes</td><td>0.0288 ms</td><td>4.55 s</td><td>SELECT "instance"."id", "instance"."domain", "instance"."published", "instance"."updated", "instance"."software", "instance"."version" FROM ("instance" INNER JOIN "federation_allowlist" ON ("federation_allowlist"."instance_id" = "instance"."id"))</td>
</tr><tr><td>9.</td><td><b>158195</b></td><td>0</td><td>Yes</td><td>0.0271 ms</td><td>4.29 s</td><td>SELECT "instance"."id", "instance"."domain", "instance"."published", "instance"."updated", "instance"."software", "instance"."version" FROM ("instance" INNER JOIN "federation_blocklist" ON ("federation_blocklist"."instance_id" = "instance"."id"))</td>
</tr><tr><td>10.</td><td><b>123856</b></td><td>123856</td><td>No</td><td>0.0258 ms</td><td>3.19 s</td><td>SELECT $2 FROM ONLY "public"."user_" x WHERE "id" OPERATOR(pg_catalog.=) $1 FOR KEY SHARE OF x</td>
</tr></tbody></table></div><div><h4>Run: <!-- -->pg-synchronous-commit</h4><table>
<thead><tr><th>Top</th><th>Calls</th><th>Rows</th><th>Toplevel</th><th>Avg. Time</th><th>Total Time</th><th>Query</th></tr></thead>
<tbody><tr><td>1.</td><td><b>2089284</b></td><td>2089284</td><td>Yes</td><td>0.00213 ms</td><td>4.45 s</td><td>SELECT $1</td>
</tr><tr><td>2.</td><td><b>550891</b></td><td>550891</td><td>No</td><td>0.0571 ms</td><td>31.5 s</td><td>SELECT $2 FROM ONLY "public"."language" x WHERE "id" OPERATOR(pg_catalog.=) $1 FOR KEY SHARE OF x</td>
</tr><tr><td>3.</td><td><b>540643</b></td><td>540643</td><td>No</td><td>0.0133 ms</td><td>7.19 s</td><td>SELECT $2 FROM ONLY "public"."community" x WHERE "id" OPERATOR(pg_catalog.=) $1 FOR KEY SHARE OF x</td>
</tr><tr><td>4.</td><td><b>338700</b></td><td>286929</td><td>Yes</td><td>0.0333 ms</td><td>11.3 s</td><td>SELECT "post"."id", "post"."name", "post"."url", "post"."body", "post"."creator_id", "post"."community_id", "post"."removed", "post"."locked", "post"."published", "post"."updated", "post"."deleted", "post"."nsfw", "post"."embed_title", "post"."embed_description", "post"."thumbnail_url", "post"."ap_id", "post"."local", "post"."embed_video_url", "post"."language_id", "post"."featured_community", "post"."featured_local" FROM "post" WHERE ("post"."ap_id" = $1) LIMIT $2</td>
</tr><tr><td>5.</td><td><b>329882</b></td><td>320105</td><td>Yes</td><td>0.0326 ms</td><td>10.7 s</td><td>SELECT "person"."id", "person"."name", "person"."display_name", "person"."avatar", "person"."banned", "person"."published", "person"."updated", "person"."actor_id", "person"."bio", "person"."local", "person"."private_key", "person"."public_key", "person"."last_refreshed_at", "person"."banner", "person"."deleted", "person"."inbox_url", "person"."shared_inbox_url", "person"."matrix_user_id", "person"."admin", "person"."bot_account", "person"."ban_expires", "person"."instance_id" FROM "person" WHERE (("person"."deleted" = $1) AND ("person"."actor_id" = $2)) LIMIT $3</td>
</tr><tr><td>6.</td><td><b>258104</b></td><td>258103</td><td>Yes</td><td>0.0208 ms</td><td>5.38 s</td><td>SELECT "local_site"."id", "local_site"."site_id", "local_site"."site_setup", "local_site"."enable_downvotes", "local_site"."enable_nsfw", "local_site"."community_creation_admin_only", "local_site"."require_email_verification", "local_site"."application_question", "local_site"."private_instance", "local_site"."default_theme", "local_site"."default_post_listing_type", "local_site"."legal_information", "local_site"."hide_modlog_mod_names", "local_site"."application_email_admins", "local_site"."slur_filter_regex", "local_site"."actor_name_max_length", "local_site"."federation_enabled", "local_site"."captcha_enabled", "local_site"."captcha_difficulty", "local_site"."published", "local_site"."updated", "local_site"."registration_mode", "local_site"."reports_email_admins" FROM "local_site" LIMIT $1</td>
</tr><tr><td>7.</td><td><b>204480</b></td><td>204480</td><td>Yes</td><td>0.0305 ms</td><td>6.23 s</td><td>SELECT "community"."id", "community"."name", "community"."title", "community"."description", "community"."removed", "community"."published", "community"."updated", "community"."deleted", "community"."nsfw", "community"."actor_id", "community"."local", "community"."private_key", "community"."public_key", "community"."last_refreshed_at", "community"."icon", "community"."banner", "community"."followers_url", "community"."inbox_url", "community"."shared_inbox_url", "community"."hidden", "community"."posting_restricted_to_mods", "community"."instance_id", "community"."moderators_url", "community"."featured_url" FROM "community" WHERE ("community"."id" = $1) LIMIT $2</td>
</tr><tr><td>8.</td><td><b>158199</b></td><td>0</td><td>Yes</td><td>0.0218 ms</td><td>3.45 s</td><td>SELECT "instance"."id", "instance"."domain", "instance"."published", "instance"."updated", "instance"."software", "instance"."version" FROM ("instance" INNER JOIN "federation_blocklist" ON ("federation_blocklist"."instance_id" = "instance"."id"))</td>
</tr><tr><td>9.</td><td><b>158199</b></td><td>0</td><td>Yes</td><td>0.0235 ms</td><td>3.72 s</td><td>SELECT "instance"."id", "instance"."domain", "instance"."published", "instance"."updated", "instance"."software", "instance"."version" FROM ("instance" INNER JOIN "federation_allowlist" ON ("federation_allowlist"."instance_id" = "instance"."id"))</td>
</tr><tr><td>10.</td><td><b>121279</b></td><td>121279</td><td>No</td><td>0.0206 ms</td><td>2.5 s</td><td>SELECT $2 FROM ONLY "public"."user_" x WHERE "id" OPERATOR(pg_catalog.=) $1 FOR KEY SHARE OF x</td>
</tr></tbody></table></div></div></details><details><summary><h2>Top Queries by total time</h2></summary><div><div><h4>Run: <!-- -->pg-asynchronous-commit</h4><table>
<thead><tr><th>Top</th><th>Calls</th><th>Rows</th><th>Toplevel</th><th>Avg. Time</th><th>Total Time</th><th>Query</th></tr></thead>
<tbody><tr><td>1.</td><td>82164</td><td>82164</td><td>Yes</td><td>26.6 ms</td><td><b>36 min 29.2 s</b></td><td>INSERT INTO "post_like" ("post_id", "person_id", "score") VALUES ($1, $2, $3) ON CONFLICT ("post_id", "person_id") DO UPDATE SET "post_id" = $4, "person_id" = $5, "score" = $6 RETURNING "post_like"."id", "post_like"."post_id", "post_like"."person_id", "post_like"."score", "post_like"."published"</td>
</tr><tr><td>2.</td><td>79161</td><td>79161</td><td>No</td><td>22.3 ms</td><td><b>29 min 26.9 s</b></td><td>update person_aggregates ua
    set post_score = post_score + NEW.score
    from post p
    where ua.person_id = p.creator_id and p.id = NEW.post_id</td>
</tr><tr><td>3.</td><td>78021</td><td>37132</td><td>Yes</td><td>21.8 ms</td><td><b>28 min 20.9 s</b></td><td>DELETE  FROM "post_like" WHERE (("post_like"."post_id" = $1) AND ("post_like"."person_id" = $2))</td>
</tr><tr><td>4.</td><td>37132</td><td>37132</td><td>No</td><td>40.1 ms</td><td><b>24 min 47.8 s</b></td><td>update person_aggregates ua
    set post_score = post_score - OLD.score
    from post p
    where ua.person_id = p.creator_id and p.id = OLD.post_id</td>
</tr><tr><td>5.</td><td>2900</td><td>533600</td><td>Yes</td><td>31 ms</td><td><b>89.8 s</b></td><td>INSERT INTO "community_language" ("community_id", "language_id") VALUES ($1, $2), ($3, $4), ($5, $6), ($7, $8), ($9, $10), ($11, $12), ($13, $14), ($15, $16), ($17, $18), ($19, $20), ($21, $22), ($23, $24), ($25, $26), ($27, $28), ($29, $30), ($31, $32), ($33, $34), ($35, $36), ($37, $38), ($39, $40), ($41, $42), ($43, $44), ($45, $46), ($47, $48), ($49, $50), ($51, $52), ($53, $54), ($55, $56), ($57, $58), ($59, $60), ($61, $62), ($63, $64), ($65, $66), ($67, $68), ($69, $70), ($71, $72), ($73, $74), ($75, $76), ($77, $78), ($79, $80), ($81, $82), ($83, $84), ($85, $86), ($87, $88), ($89, $90), ($91, $92), ($93, $94), ($95, $96), ($97, $98), ($99, $100), ($101, $102), ($103, $104), ($105, $106), ($107, $108), ($109, $110), ($111, $112), ($113, $114), ($115, $116), ($117, $118), ($119, $120), ($121, $122), ($123, $124), ($125, $126), ($127, $128), ($129, $130), ($131, $132), ($133, $134), ($135, $136), ($137, $138), ($139, $140), ($141, $142), ($143, $144), ($145, $146), ($147, $148), ($149, $150), ($151, $152), ($153, $154), ($155, $156), ($157, $158), ($159, $160), ($161, $162), ($163, $164), ($165, $166), ($167, $168), ($169, $170), ($171, $172), ($173, $174), ($175, $176), ($177, $178), ($179, $180), ($181, $182), ($183, $184), ($185, $186), ($187, $188), ($189, $190), ($191, $192), ($193, $194), ($195, $196), ($197, $198), ($199, $200), ($201, $202), ($203, $204), ($205, $206), ($207, $208), ($209, $210), ($211, $212), ($213, $214), ($215, $216), ($217, $218), ($219, $220), ($221, $222), ($223, $224), ($225, $226), ($227, $228), ($229, $230), ($231, $232), ($233, $234), ($235, $236), ($237, $238), ($239, $240), ($241, $242), ($243, $244), ($245, $246), ($247, $248), ($249, $250), ($251, $252), ($253, $254), ($255, $256), ($257, $258), ($259, $260), ($261, $262), ($263, $264), ($265, $266), ($267, $268), ($269, $270), ($271, $272), ($273, $274), ($275, $276), ($277, $278), ($279, $280), ($281, $282), ($283, $284), ($285, $286), ($287, $288), ($289, $290), ($291, $292), ($293, $294), ($295, $296), ($297, $298), ($299, $300), ($301, $302), ($303, $304), ($305, $306), ($307, $308), ($309, $310), ($311, $312), ($313, $314), ($315, $316), ($317, $318), ($319, $320), ($321, $322), ($323, $324), ($325, $326), ($327, $328), ($329, $330), ($331, $332), ($333, $334), ($335, $336), ($337, $338), ($339, $340), ($341, $342), ($343, $344), ($345, $346), ($347, $348), ($349, $350), ($351, $352), ($353, $354), ($355, $356), ($357, $358), ($359, $360), ($361, $362), ($363, $364), ($365, $366), ($367, $368) RETURNING "community_language"."id", "community_language"."community_id", "community_language"."language_id"</td>
</tr><tr><td>6.</td><td>550952</td><td>550952</td><td>No</td><td>0.0831 ms</td><td><b>45.8 s</b></td><td>SELECT $2 FROM ONLY "public"."language" x WHERE "id" OPERATOR(pg_catalog.=) $1 FOR KEY SHARE OF x</td>
</tr><tr><td>7.</td><td>79161</td><td>79161</td><td>No</td><td>0.312 ms</td><td><b>24.7 s</b></td><td>update post_aggregates pa
    set score = score + NEW.score,
    upvotes = case when NEW.score = $16 then upvotes + $17 else upvotes end,
    downvotes = case when NEW.score = $18 then downvotes + $19 else downvotes end
    where pa.post_id = NEW.post_id</td>
</tr><tr><td>8.</td><td>13025</td><td>13025</td><td>Yes</td><td>1.86 ms</td><td><b>24.2 s</b></td><td>INSERT INTO "comment" ("creator_id", "post_id", "content", "removed", "published", "updated", "deleted", "ap_id", "local", "distinguished", "language_id") VALUES ($1, $2, $3, DEFAULT, $4, DEFAULT, $5, $6, $7, DEFAULT, DEFAULT) ON CONFLICT ("ap_id") DO UPDATE SET "creator_id" = $8, "post_id" = $9, "content" = $10, "published" = $11, "deleted" = $12, "ap_id" = $13, "local" = $14 RETURNING "comment"."id", "comment"."creator_id", "comment"."post_id", "comment"."content", "comment"."removed", "comment"."published", "comment"."updated", "comment"."deleted", "comment"."ap_id", "comment"."local", "comment"."path", "comment"."distinguished", "comment"."language_id"</td>
</tr><tr><td>9.</td><td>37132</td><td>37132</td><td>No</td><td>0.488 ms</td><td><b>18.1 s</b></td><td>update post_aggregates pa
    set score = score - OLD.score,
    upvotes = case when OLD.score = $18 then upvotes - $19 else upvotes end,
    downvotes = case when OLD.score = $20 then downvotes - $21 else downvotes end
    from post p
    where pa.post_id = p.id
    and pa.post_id = OLD.post_id</td>
</tr><tr><td>10.</td><td>17789</td><td>17789</td><td>Yes</td><td>0.786 ms</td><td><b>14 s</b></td><td>INSERT INTO "comment_like" ("person_id", "comment_id", "post_id", "score") VALUES ($1, $2, $3, $4) ON CONFLICT ("comment_id", "person_id") DO UPDATE SET "person_id" = $5, "comment_id" = $6, "post_id" = $7, "score" = $8 RETURNING "comment_like"."id", "comment_like"."person_id", "comment_like"."comment_id", "comment_like"."post_id", "comment_like"."score", "comment_like"."published"</td>
</tr></tbody></table></div><div><h4>Run: <!-- -->pg-synchronous-commit</h4><table>
<thead><tr><th>Top</th><th>Calls</th><th>Rows</th><th>Toplevel</th><th>Avg. Time</th><th>Total Time</th><th>Query</th></tr></thead>
<tbody><tr><td>1.</td><td>82164</td><td>82164</td><td>Yes</td><td>0.258 s</td><td><b>353 min 16.9 s</b></td><td>INSERT INTO "post_like" ("post_id", "person_id", "score") VALUES ($1, $2, $3) ON CONFLICT ("post_id", "person_id") DO UPDATE SET "post_id" = $4, "person_id" = $5, "score" = $6 RETURNING "post_like"."id", "post_like"."post_id", "post_like"."person_id", "post_like"."score", "post_like"."published"</td>
</tr><tr><td>2.</td><td>76734</td><td>76734</td><td>No</td><td>0.23 s</td><td><b>294 min 25.8 s</b></td><td>update person_aggregates ua
    set post_score = post_score + NEW.score
    from post p
    where ua.person_id = p.creator_id and p.id = NEW.post_id</td>
</tr><tr><td>3.</td><td>78021</td><td>34705</td><td>Yes</td><td>0.195 s</td><td><b>253 min 38.7 s</b></td><td>DELETE  FROM "post_like" WHERE (("post_like"."post_id" = $1) AND ("post_like"."person_id" = $2))</td>
</tr><tr><td>4.</td><td>34705</td><td>34705</td><td>No</td><td>0.388 s</td><td><b>224 min 36 s</b></td><td>update person_aggregates ua
    set post_score = post_score - OLD.score
    from post p
    where ua.person_id = p.creator_id and p.id = OLD.post_id</td>
</tr><tr><td>5.</td><td>12964</td><td>12964</td><td>Yes</td><td>65.4 ms</td><td><b>14 min 7.57 s</b></td><td>INSERT INTO "comment" ("creator_id", "post_id", "content", "removed", "published", "updated", "deleted", "ap_id", "local", "distinguished", "language_id") VALUES ($1, $2, $3, DEFAULT, $4, DEFAULT, $5, $6, $7, DEFAULT, DEFAULT) ON CONFLICT ("ap_id") DO UPDATE SET "creator_id" = $8, "post_id" = $9, "content" = $10, "published" = $11, "deleted" = $12, "ap_id" = $13, "local" = $14 RETURNING "comment"."id", "comment"."creator_id", "comment"."post_id", "comment"."content", "comment"."removed", "comment"."published", "comment"."updated", "comment"."deleted", "comment"."ap_id", "comment"."local", "comment"."path", "comment"."distinguished", "comment"."language_id"</td>
</tr><tr><td>6.</td><td>12964</td><td>12964</td><td>No</td><td>47 ms</td><td><b>10 min 9.41 s</b></td><td>update community_aggregates ca
set comments = comments + $15 from comment c, post p
where p.id = c.post_id
  and p.id = NEW.post_id
  and ca.community_id = p.community_id</td>
</tr><tr><td>7.</td><td>17728</td><td>17728</td><td>Yes</td><td>27.8 ms</td><td><b>8 min 12 s</b></td><td>INSERT INTO "comment_like" ("person_id", "comment_id", "post_id", "score") VALUES ($1, $2, $3, $4) ON CONFLICT ("comment_id", "person_id") DO UPDATE SET "person_id" = $5, "comment_id" = $6, "post_id" = $7, "score" = $8 RETURNING "comment_like"."id", "comment_like"."person_id", "comment_like"."comment_id", "comment_like"."post_id", "comment_like"."score", "comment_like"."published"</td>
</tr><tr><td>8.</td><td>17699</td><td>17699</td><td>No</td><td>13.4 ms</td><td><b>3 min 57.9 s</b></td><td>update comment_aggregates ca
    set score = score + NEW.score,
    upvotes = case when NEW.score = $16 then upvotes + $17 else upvotes end,
    downvotes = case when NEW.score = $18 then downvotes + $19 else downvotes end
    where ca.comment_id = NEW.comment_id</td>
</tr><tr><td>9.</td><td>17699</td><td>17699</td><td>No</td><td>13.4 ms</td><td><b>3 min 57 s</b></td><td>update person_aggregates ua
    set comment_score = comment_score + NEW.score
    from comment c
    where ua.person_id = c.creator_id and c.id = NEW.comment_id</td>
</tr><tr><td>10.</td><td>12964</td><td>12964</td><td>No</td><td>17.3 ms</td><td><b>3 min 44.1 s</b></td><td>update person_aggregates
        set comment_count = comment_count + $15 where person_id = NEW.creator_id</td>
</tr></tbody></table></div></div></details><details><summary><h2>Flamegraphs</h2></summary>(click for interactive)<div><a href="https://phiresky.github.io/lemmy-perf-data/runs/2023-07-03T17:28:49+00:00-pg-asynchronous-commit/perf.data.flamegraph.svg"><img src="https://phiresky.github.io/lemmy-perf-data/runs/2023-07-03T17:28:49+00:00-pg-asynchronous-commit/perf.data.flamegraph.svg"/></a></div><div><a href="https://phiresky.github.io/lemmy-perf-data/runs/2023-07-03T17:31:43+00:00-pg-synchronous-commit/perf.data.flamegraph.svg"><img src="https://phiresky.github.io/lemmy-perf-data/runs/2023-07-03T17:31:43+00:00-pg-synchronous-commit/perf.data.flamegraph.svg"/></a></div></details></div>
